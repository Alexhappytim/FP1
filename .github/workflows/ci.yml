name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  format-check:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Install Fantomas
      run: dotnet tool install -g fantomas
    
    - name: Check F# code formatting
      run: |
        echo "Checking F# code formatting with Fantomas..."
        fantomas --check . || (echo "::error::Code is not formatted. Run 'fantomas .' locally to fix." && exit 1)
    
    - name: Format check summary
      if: failure()
      run: |
        echo "::warning::Formatting issues detected. Please run 'dotnet fantomas .' to auto-format your code."

  lint:
    name: Linting and Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '7.0.x'
    
    - name: Install FSharpLint
      run: dotnet tool install -g dotnet-fsharplint
    
    - name: Run FSharpLint
      run: |
        echo "Running FSharpLint with all warnings enabled..."
        dotnet fsharplint lint FP.sln || dotnet fsharplint lint *.fsx || echo "::warning::FSharpLint check completed with warnings"
    
    - name: Install F# Analyzer
      run: dotnet tool install -g fsharp-analyzers
      continue-on-error: true
    
    - name: Static analysis summary
      run: |
        echo "::notice::Linting completed. Review any warnings above."

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: ['7.0.x', '8.0.x']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET ${{ matrix.dotnet-version }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
    
    - name: Display .NET version
      run: dotnet --version
    
    - name: Restore dependencies
      run: dotnet restore || echo "No project file found, continuing..."
      continue-on-error: true
    
    - name: Build scripts
      run: |
        echo "Building F# scripts..."
        dotnet fsi --exec Tests.fsx || (echo "::error::Tests.fsx failed to execute" && exit 1)
    
    - name: Run Collatz problem
      run: |
        echo "Running Collatz problem solution..."
        dotnet fsi --exec collatz.fsx || (echo "::error::collatz.fsx failed to execute" && exit 1)
    
    - name: Run unit tests
      run: |
        if [ -f "Tests.fsx" ]; then
          echo "Running unit tests..."
          dotnet fsi Tests.fsx
        else
          echo "::warning::No Tests.fsx file found"
        fi
      continue-on-error: false
    
    - name: Run test project (if exists)
      run: |
        if ls *.Tests.fsproj 1> /dev/null 2>&1; then
          dotnet test --verbosity normal --logger "trx;LogFileName=test-results.trx"
        else
          echo "No test project found, skipping..."
        fi
      continue-on-error: true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.dotnet-version }}
        path: '**/*.trx'
      continue-on-error: true

  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '7.0.x'
    
    - name: Check F# syntax
      run: |
        echo "Validating F# syntax..."
        for file in *.fsx; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            dotnet fsi --nologo --simpleresolution "$file" 2>&1 | grep -i "error" && \
            (echo "::error file=$file::Syntax error in $file" && exit 1) || echo "$file OK"
          fi
        done
    
    - name: Syntax check summary
      if: success()
      run: echo "::notice::All F# scripts passed syntax validation"

  warnings-check:
    name: Check for Compiler Warnings
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '7.0.x'
    
    - name: Enable strict warnings
      run: |
        echo "Checking for compiler warnings with strict mode..."
        for file in *.fsx; do
          if [ -f "$file" ]; then
            echo "Analyzing $file with all warnings enabled..."
            # Run with warnings as errors
            dotnet fsi --warnaserror+ --warnon:3390 --warnon:0044 "$file" 2>&1 | tee -a warnings.log || true
          fi
        done
    
    - name: Display warnings
      run: |
        if [ -f warnings.log ]; then
          echo "::warning::Compiler warnings detected:"
          cat warnings.log
        else
          echo "::notice::No compiler warnings found"
        fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [format-check, lint, build-and-test, syntax-check, warnings-check]
    if: always()
    
    steps:
    - name: Check results
      run: |
        echo "### CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Format Check: ${{ needs.format-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build and Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Syntax Check: ${{ needs.syntax-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Warnings Check: ${{ needs.warnings-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.format-check.result }}" != "success" ] || \
           [ "${{ needs.lint.result }}" != "success" ] || \
           [ "${{ needs.build-and-test.result }}" != "success" ] || \
           [ "${{ needs.syntax-check.result }}" != "success" ]; then
          echo "::error::Pipeline failed. Please review the logs above."
          exit 1
        fi
        
        echo "::notice::All checks passed successfully!"
